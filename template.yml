AWSTemplateFormatVersion: 2010-09-09
Transform:
  - AWS::Serverless-2016-10-31
  - AWS::CodeStar

Parameters:
  ProjectId:
    Type: String
    Description: CodeStar projectId used to associate new resources to team members.
  CodeDeployRole:
    Type: String
    Description: IAM role to allow AWS CodeDeploy to manage deployment of AWS Lambda functions.
  Stage:
    Type: String
    Description: The name for a project pipeline stage, such as stg or Prod, for which resources are provisioned and deployed.
    Default: ""

Globals:
  Function:
    AutoPublishAlias: live
    Tags:
      Project-Code: <Project-Code>
      Project-Name: <Project-Name>
    Environment:
      Variables:
        LD_LIBRARY_PATH: "local/lib:$LD_LIBRARY_PATH"
        DATA_BUCKET: !Sub "<equity_infrastructure_bucket>-${Stage}"
        DATA_BUCKET_REGION:  <some-region>
        API_BUCKET: !Sub "<equity_file_bucket>-${Stage}"
        FILE_BUCKET_REGION:  <some-region>
    DeploymentPreference:
      Enabled: true
      Type: AllAtOnce
      Role: !Ref CodeDeployRole

Resources:
  EquityAssessment:
    Type: AWS::Serverless::Function
    Properties:
      Handler: equity_calculations.handler
      Runtime: python3.9
      Timeout: 900
      MemorySize: 6016
      AutoPublishCodeSha256: "11"
      FunctionName: !Sub "<some-name>-${Stage}"
      CodeUri:
        Bucket: !Sub "<equity_infrastructure_bucket>-${Stage}"
        Key: !Sub "lambda/equity_tool_deployment_package.zip"
      Role: arn:aws:iam::<some-account>:role/equity-assessment-tool-lambda-role
      Tags:
        TAG1: Project-Code <Project-Code>
        TAG2: Project-Name  <Project-Name>
        TAG3: Name  <equity_file_bucket>
        TAG4: Tech-Team DS
        TAG5: Center Tech
      Events:
        CreateOutputEvent:
          Type: S3
          Properties:
            Bucket: !Ref EquityAssessmentBucket # bucket must be created in the same template
            Events: s3:ObjectCreated:*
            Filter:
              S3Key:
                Rules:
                  - Name: prefix
                    Value: input-data/
                  - Name: suffix
                    Value: .csv

  EquityToolBackendAPI:
    Type: AWS::Serverless::Api
    Properties:
      StageName: !Sub "${Stage}"
      Name: !Sub "<some-name>-${Stage}"
      Auth:
        ApiKeyRequired: true # sets for all methods
        UsagePlan:
          CreateUsagePlan: PER_API
          Description: Developer Usage plan for this API
          UsagePlanName: !Sub "<some-name>-${Stage}"
          Tags:
            - Key: "Project-Code"
              Value: " <Project-Code>"
            - Key: "Project-Name"
              Value: " <Project-Name>"
            - Key: "Name"
              Value: " <equity_file_bucket>"
            - Key: "Tech-Team"
              Value: "DS"
            - Key: "Center"
              Value: "Tech"

  StatusChecker:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ./scripts/lambda/
      Handler: getstatus_and_getfile.handler
      Runtime: python3.8
      Timeout: 45
      MemorySize: 1028
      FunctionName: !Sub "equity-tool-job-checker-${Stage}"
      Role: arn:aws:iam:: <some-account>:role/equity-assessment-tool-lambda-role
      Events:
        GetStatusEvent:
          Type: Api
          Properties:
            RestApiId: !Ref EquityToolBackendAPI
            Path: /getstatus/{fileid}
            Method: get
            Auth:
              ApiKeyRequired: true
        SubmitJobEvent:
          Type: Api
          Properties:
            RestApiId: !Ref EquityToolBackendAPI
            Path: /getfile/{fileid}
            Method: get
            Auth:
              ApiKeyRequired: true

  EquityAssessmentBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub " <equity_file_bucket>-${Stage}"
      Tags:
        - Key: "Project-Code"
          Value: " <Project-Code>"
        - Key: "Project-Name"
          Value: " <Project-Name>"
        - Key: "Name"
          Value: "<equity_file_bucket>"
        - Key: "Tech-Team"
          Value: "DS"
        - Key: "Center"
          Value: "Tech"
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      LifecycleConfiguration:
        Rules:
          - Id: DeleteInputData
            Prefix: input-data/
            Status: Enabled
            ExpirationInDays: "7"
          - Id: DeleteDemoData
            Prefix: output-data/demographic-bias/
            Status: Enabled
            ExpirationInDays: "7"
          - Id: DeleteGeoData
            Prefix: input-data/geo-bias/
            Status: Enabled
            ExpirationInDays: "7"

  SampleBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket:
        Ref: EquityAssessmentBucket
      PolicyDocument:
        Statement:
          - Action:
              - "s3:GetObject"
            Effect: "Allow"
            Resource:
              Fn::Join:
                - ""
                - - "arn:aws:s3:::"
                  - Ref: EquityAssessmentBucket
                  - "/reference-data/sample-data/*"
            Principal: "*"
